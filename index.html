<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAERS Advanced Research Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .tab:not(.active):hover {
            background: #f7fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .form-group label .tooltip {
            margin-left: 8px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            display: grid;
            gap: 30px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
        }

        .stat-card.primary { border-left-color: #667eea; }
        .stat-card.success { border-left-color: #48bb78; }
        .stat-card.warning { border-left-color: #ed8936; }
        .stat-card.danger { border-left-color: #f56565; }

        .stat-header {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Fixed chart heights */
        .chart-container canvas {
            max-height: 400px !important;
            height: 400px !important;
        }

        .timeline-chart {
            max-height: 300px !important;
            height: 300px !important;
        }

        .advanced-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 200px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        th:hover {
            background: #edf2f7;
        }

        tr:hover {
            background: #f7fafc;
        }

        .sortable::after {
            content: ' ‚Üï';
            color: #cbd5e0;
        }

        .prr-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .prr-high { background: #fed7d7; color: #c53030; }
        .prr-medium { background: #feebc8; color: #dd6b20; }
        .prr-low { background: #c6f6d5; color: #2f855a; }

        .ci-display {
            font-size: 0.8rem;
            color: #666;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1rem;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .saved-searches {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .saved-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1rem;
            color: #4a5568;
        }

        .comparison-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .drug-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .heatmap-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
        }

        .heatmap-cell {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin: 1px;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .comparison-view {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
                margin-bottom: 5px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .drug-selector {
                grid-template-columns: 1fr;
            }
        }

        .advanced-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ FAERS Advanced Research Platform</h1>
            <p>Plataforma avan√ßada para an√°lise de farmacovigil√¢ncia com dados do FDA. An√°lise estat√≠stica completa, visualiza√ß√µes interativas e relat√≥rios profissionais para pesquisa cient√≠fica.</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('search', this)">üîç Busca Avan√ßada</div>
            <div class="tab" onclick="switchTab('analysis', this)">üìä An√°lise Estat√≠stica</div>
            <div class="tab" onclick="switchTab('comparison', this)">‚öñÔ∏è Compara√ß√£o</div>
            <div class="tab" onclick="switchTab('trends', this)">üìà Tend√™ncias</div>
            <div class="tab" onclick="switchTab('export', this)">üíæ Exporta√ß√£o</div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content active">
            <div class="search-panel">
                <form id="advancedSearchForm">
                    <div class="search-grid">
                        <div class="form-group">
                            <label for="drugNames">
                                Medicamento(s) 
                                <span class="tooltip" title="Digite um ou m√∫ltiplos medicamentos separados por v√≠rgula">?</span>
                            </label>
                            <textarea id="drugNames" placeholder="Ex: faricimab, ticagrelor, semaglutide" rows="3" required></textarea>
                        </div>

                        <div class="form-group">
                            <label>Per√≠odo de An√°lise</label>
                            <div class="date-range">
                                <input type="date" id="startDate" value="2022-01-01">
                                <input type="date" id="endDate" value="2024-12-31">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="ageRange">Faixa Et√°ria</label>
                            <select id="ageRange">
                                <option value="">Todas as idades</option>
                                <option value="[0+TO+17]">Pedi√°trica (0-17 anos)</option>
                                <option value="[18+TO+64]">Adulta (18-64 anos)</option>
                                <option value="[65+TO+120]">Idosa (65+ anos)</option>
                                <option value="[0+TO+1]">Neonatal (0-1 ano)</option>
                                <option value="[2+TO+11]">Infantil (2-11 anos)</option>
                                <option value="[12+TO+17]">Adolescente (12-17 anos)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="gender">G√™nero</label>
                            <select id="gender">
                                <option value="">Todos</option>
                                <option value="1">Masculino</option>
                                <option value="2">Feminino</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="country">Pa√≠s/Regi√£o</label>
                            <select id="country">
                                <option value="">Todos os pa√≠ses</option>
                                <option value="BR">Brasil</option>
                                <option value="US">Estados Unidos</option>
                                <option value="CA">Canad√°</option>
                                <option value="GB">Reino Unido</option>
                                <option value="DE">Alemanha</option>
                                <option value="FR">Fran√ßa</option>
                                <option value="JP">Jap√£o</option>
                                <option value="AU">Austr√°lia</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="serious">Gravidade</label>
                            <select id="serious">
                                <option value="">Todos</option>
                                <option value="1">Apenas eventos s√©rios</option>
                                <option value="2">Apenas eventos n√£o-s√©rios</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="reporterType">Tipo de Relat√≥rio</label>
                            <select id="reporterType">
                                <option value="">Todos</option>
                                <option value="1">M√©dico</option>
                                <option value="2">Farmac√™utico</option>
                                <option value="3">Outro profissional de sa√∫de</option>
                                <option value="4">Advogado</option>
                                <option value="5">Consumidor/Paciente</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="outcomes">Desfechos de Interesse</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="death" value="DE">
                                    <label for="death">Morte</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hospitalization" value="HO">
                                    <label for="hospitalization">Hospitaliza√ß√£o</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="disability" value="DS">
                                    <label for="disability">Incapacidade</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="lifeThreat" value="LT">
                                    <label for="lifeThreat">Amea√ßa √† vida</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary" id="searchBtn">
                            üîç Executar An√°lise
                        </button>
                        <button type="button" class="btn btn-outline" onclick="saveSearch()">
                            üíæ Salvar Busca
                        </button>
                        <button type="button" class="btn btn-outline" onclick="loadSavedSearch()">
                            üìÇ Carregar Busca
                        </button>
                        <button type="button" class="btn btn-outline" onclick="resetForm()">
                            üîÑ Limpar
                        </button>
                    </div>
                </form>

                <div class="saved-searches" id="savedSearches" style="display: none;">
                    <h4>Buscas Salvas</h4>
                    <div id="savedSearchList"></div>
                </div>
            </div>

            <div class="error" id="errorMsg"></div>
            <div class="loading" id="loading">
                <div>üîÑ Executando an√°lise avan√ßada...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="loadingStatus">Preparando consulta...</div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <div class="stats-overview" id="statsOverview" style="display: none;"></div>
            
            <div class="chart-container" id="mainCharts" style="display: none;">
                <div class="chart-header">
                    <h3 class="chart-title">üìä An√°lise de Eventos Adversos</h3>
                    <div class="chart-controls">
                        <select id="chartType" onchange="updateChart()">
                            <option value="bar">Gr√°fico de Barras</option>
                            <option value="pie">Gr√°fico de Pizza</option>
                            <option value="doughnut">Gr√°fico de Rosca</option>
                        </select>
                        <select id="chartLimit" onchange="updateChart()">
                            <option value="10">Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                            <option value="50">Top 50</option>
                        </select>
                    </div>
                </div>
                <canvas id="mainChart"></canvas>
            </div>

            <div class="chart-container" id="timelineContainer" style="display: none;">
                <div class="chart-header">
                    <h3 class="chart-title">üìà An√°lise Temporal</h3>
                </div>
                <canvas id="timelineChart" class="timeline-chart"></canvas>
            </div>

            <div class="advanced-table" id="advancedTable" style="display: none;">
                <div class="table-header">
                    <h3>‚öóÔ∏è An√°lise Estat√≠stica Detalhada</h3>
                    <div class="table-controls">
                        <input type="text" id="tableSearch" class="search-input" placeholder="Buscar eventos..." onkeyup="filterTable()">
                        <select id="sortBy" onchange="sortTable()">
                            <option value="count">Ordenar por Contagem</option>
                            <option value="prr">Ordenar por PRR</option>
                            <option value="ror">Ordenar por ROR</option>
                            <option value="event">Ordenar por Evento</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortColumn(0)">Evento Adverso</th>
                                <th class="sortable" onclick="sortColumn(1)">Contagem</th>
                                <th class="sortable" onclick="sortColumn(2)">% Total</th>
                                <th class="sortable" onclick="sortColumn(3)">PRR</th>
                                <th class="sortable" onclick="sortColumn(4)">ROR</th>
                                <th class="sortable" onclick="sortColumn(5)">IC</th>
                                <th class="sortable" onclick="sortColumn(6)">Status</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparison-tab" class="tab-content">
            <div class="comparison-controls">
                <h3>‚öñÔ∏è Compara√ß√£o entre Medicamentos</h3>
                <div class="drug-selector">
                    <div class="form-group">
                        <label for="drugA">Medicamento A</label>
                        <select id="drugA">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="drugB">Medicamento B</label>
                        <select id="drugB">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateComparison()">
                    üìä Gerar Compara√ß√£o
                </button>
            </div>
            
            <div class="comparison-view" id="comparisonView" style="display: none;">
                <div class="chart-container">
                    <h4>üìä Eventos Adversos por Medicamento</h4>
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>üìà M√©tricas Comparativas</h4>
                    <div id="comparisonMetrics"></div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div id="trends-tab" class="tab-content">
            <div class="chart-container">
                <h3>üìà An√°lise de Tend√™ncias Temporais</h3>
                <canvas id="trendsChart"></canvas>
            </div>
            <div class="heatmap-container">
                <h3>üî• Mapa de Calor: Eventos por Per√≠odo</h3>
                <div id="heatmapViz"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
            <div class="search-panel">
                <h3>üíæ Exporta√ß√£o e Relat√≥rios</h3>
                <div class="export-options">
                    <button class="btn btn-secondary" onclick="exportToCSV()">
                        üìÑ Exportar CSV Completo
                    </button>
                    <button class="btn btn-secondary" onclick="exportToJSON()">
                        üìã Exportar JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportToPDF()">
                        üìÉ Relat√≥rio PDF
                    </button>
                    <button class="btn btn-secondary" onclick="exportCharts()">
                        üìä Gr√°ficos em Alta Resolu√ß√£o
                    </button>
                    <button class="btn btn-secondary" onclick="exportStatistics()">
                        üßÆ Planilha Estat√≠stica
                    </button>
                    <button class="btn btn-secondary" onclick="exportForR()">
                        üìà Dataset para R/Python
                    </button>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4>Configura√ß√µes de Exporta√ß√£o</h4>
                    <div class="search-grid">
                        <div class="form-group">
                            <label for="exportFormat">Formato de Data</label>
                            <select id="exportFormat">
                                <option value="iso">ISO (YYYY-MM-DD)</option>
                                <option value="us">US (MM/DD/YYYY)</option>
                                <option value="br">BR (DD/MM/YYYY)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="includeCI">Incluir Intervalos de Confian√ßa</label>
                            <select id="includeCI">
                                <option value="true">Sim</option>
                                <option value="false">N√£o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="significanceLevel">N√≠vel de Signific√¢ncia</label>
                            <select id="significanceLevel">
                                <option value="0.05">95% (Œ± = 0.05)</option>
                                <option value="0.01">99% (Œ± = 0.01)</option>
                                <option value="0.10">90% (Œ± = 0.10)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Event Details -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes do Evento Adverso</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentChart = null;
        let timelineChart = null;
        let comparisonChart = null;
        let trendsChart = null;
        let allEventData = [];
        let timelineData = [];
        let savedSearches = [];

        // Load saved searches from localStorage safely
        try {
            savedSearches = JSON.parse(localStorage.getItem('faers_searches') || '[]');
        } catch (e) {
            console.error('Error loading saved searches:', e);
            savedSearches = [];
        }

        // Tab switching
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            element.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Form handling
        document.getElementById('advancedSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeAdvancedSearch();
        });

        // Set default dates
        document.getElementById('endDate').value = new Date().toISOString().split('T')[0];

        async function executeAdvancedSearch() {
            const drugNames = document.getElementById('drugNames').value.trim();
            if (!drugNames) {
                showError('Por favor, insira pelo menos um medicamento.');
                return;
            }

            showLoading(true);
            hideError();
            
            try {
                const drugs = drugNames.split(',').map(drug => drug.trim());
                let allResults = [];
                
                for (let i = 0; i < drugs.length; i++) {
                    updateProgress((i / drugs.length) * 100, `Analisando ${drugs[i]}...`);
                    
                    const drugData = await searchSingleDrug(drugs[i]);
                    if (drugData) {
                        allResults.push(drugData);
                    }
                }

                if (allResults.length === 0) {
                    throw new Error('Nenhum dado encontrado para os medicamentos especificados.');
                }

                updateProgress(90, 'Buscando dados temporais...');
                
                // Get timeline data
                timelineData = await getTimelineData(drugs);

                updateProgress(100, 'Processando resultados...');
                
                currentData = {
                    drugs: drugs,
                    results: allResults,
                    searchParams: getSearchParams(),
                    timestamp: new Date().toISOString()
                };

                await processResults(currentData);
                updateDrugSelectors();
                switchTab('analysis', document.querySelector('.tab:nth-child(2)'));
                
            } catch (error) {
                console.error('Erro:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function searchSingleDrug(drugName) {
            const params = getSearchParams();
            let searchQuery = `patient.drug.medicinalproduct:"${drugName}"`;
            
            // Add date range
            if (params.startDate && params.endDate) {
                const startFormatted = params.startDate.replace(/-/g, '');
                const endFormatted = params.endDate.replace(/-/g, '');
                searchQuery += `+AND+receivedate:[${startFormatted}+TO+${endFormatted}]`;
            }
            
            // Add additional filters
            if (params.ageRange) searchQuery += `+AND+patient.patientonsetage:${params.ageRange}`;
            if (params.gender) searchQuery += `+AND+patient.patientsex:${params.gender}`;
            if (params.country) searchQuery += `+AND+occurcountry:"${params.country}"`;
            if (params.serious) searchQuery += `+AND+serious:${params.serious}`;
            if (params.reporterType) searchQuery += `+AND+primarysource.reporterorganization:${params.reporterType}`;
            
            // Add outcome filters
            const outcomes = getSelectedOutcomes();
            if (outcomes.length > 0) {
                const outcomeQuery = outcomes.map(o => `patient.reaction.reactionoutcome:"${o}"`).join('+OR+');
                searchQuery += `+AND+(${outcomeQuery})`;
            }

            try {
                const eventsUrl = `https://api.fda.gov/drug/event.json?search=${searchQuery}&count=patient.reaction.reactionmeddrapt.exact&limit=1000`;
                console.log('Searching:', eventsUrl);
                
                const response = await fetch(eventsUrl);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn(`No data found for ${drugName}`);
                        return null;
                    }
                    throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                return {
                    drug: drugName,
                    events: data.results || [],
                    totalReports: data.results ? data.results.reduce((sum, event) => sum + event.count, 0) : 0
                };
                
            } catch (error) {
                console.error(`Error searching for ${drugName}:`, error);
                throw new Error(`Erro ao buscar dados para ${drugName}: ${error.message}`);
            }
        }

        async function getTimelineData(drugs) {
            const timelinePromises = drugs.map(async (drug) => {
                const params = getSearchParams();
                let searchQuery = `patient.drug.medicinalproduct:"${drug}"`;
                
                if (params.startDate && params.endDate) {
                    const startFormatted = params.startDate.replace(/-/g, '');
                    const endFormatted = params.endDate.replace(/-/g, '');
                    searchQuery += `+AND+receivedate:[${startFormatted}+TO+${endFormatted}]`;
                }

                try {
                    const url = `https://api.fda.gov/drug/event.json?search=${searchQuery}&count=receivedate&limit=100`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            drug: drug,
                            timeline: data.results || []
                        };
                    }
                } catch (error) {
                    console.error(`Error getting timeline for ${drug}:`, error);
                }
                return { drug: drug, timeline: [] };
            });

            return await Promise.all(timelinePromises);
        }

        function getSearchParams() {
            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                ageRange: document.getElementById('ageRange').value,
                gender: document.getElementById('gender').value,
                country: document.getElementById('country').value,
                serious: document.getElementById('serious').value,
                reporterType: document.getElementById('reporterType').value
            };
        }

        function getSelectedOutcomes() {
            const outcomes = [];
            if (document.getElementById('death').checked) outcomes.push('DE');
            if (document.getElementById('hospitalization').checked) outcomes.push('HO');
            if (document.getElementById('disability').checked) outcomes.push('DS');
            if (document.getElementById('lifeThreat').checked) outcomes.push('LT');
            return outcomes;
        }

        async function processResults(data) {
            // Combine all events from all drugs
            allEventData = [];
            let totalReports = 0;
            
            data.results.forEach(drugResult => {
                drugResult.events.forEach(event => {
                    allEventData.push({
                        ...event,
                        drug: drugResult.drug,
                        drugTotalReports: drugResult.totalReports
                    });
                });
                totalReports += drugResult.totalReports;
            });

            // Calculate advanced statistics
            allEventData = allEventData.map(event => {
                const prr = calculatePRR(event);
                const ror = calculateROR(event);
                const ic = calculateIC(event);
                
                return {
                    ...event,
                    prr: prr,
                    ror: ror,
                    ic: ic,
                    percentage: ((event.count / totalReports) * 100).toFixed(2),
                    significance: determineSignificance(prr, ror, ic, event.count)
                };
            });

            // Sort by count descending
            allEventData.sort((a, b) => b.count - a.count);

            displayAdvancedResults(data, totalReports);
        }

        function calculatePRR(event) {
            const drugEventRate = event.count / event.drugTotalReports;
            const backgroundRate = 0.01;
            return (drugEventRate / backgroundRate).toFixed(2);
        }

        function calculateROR(event) {
            const a = event.count;
            const b = event.drugTotalReports - event.count;
            const c = 1000;
            const d = 100000;
            
            return ((a * d) / (b * c)).toFixed(2);
        }

        function calculateIC(event) {
            const observed = event.count;
            const expected = (event.drugTotalReports * 0.01);
            
            if (expected === 0) return 0;
            return (Math.log2(observed / expected)).toFixed(2);
        }

        function determineSignificance(prr, ror, ic, count) {
            if (count >= 3 && prr >= 2) return 'high';
            if (count >= 2 && prr >= 1.5) return 'medium';
            return 'low';
        }

        function displayAdvancedResults(data, totalReports) {
            displayStatsOverview(data, totalReports);
            displayAdvancedChart();
            displayTimelineChart();
            displayAdvancedTable();
            displayTrendsChart();
            
            // Show result sections
            document.getElementById('statsOverview').style.display = 'grid';
            document.getElementById('mainCharts').style.display = 'block';
            document.getElementById('timelineContainer').style.display = 'block';
            document.getElementById('advancedTable').style.display = 'block';
        }

        function displayStatsOverview(data, totalReports) {
            const uniqueEvents = new Set(allEventData.map(e => e.term)).size;
            const highSignificance = allEventData.filter(e => e.significance === 'high').length;
            const avgPRR = (allEventData.reduce((sum, e) => sum + parseFloat(e.prr), 0) / allEventData.length).toFixed(2);

            const statsHtml = `
                <div class="stat-card primary">
                    <div class="stat-header">Total de Relat√≥rios</div>
                    <div class="stat-value">${totalReports.toLocaleString()}</div>
                    <div class="stat-change">üìä Para ${data.drugs.length} medicamento(s)</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-header">Eventos √önicos</div>
                    <div class="stat-value">${uniqueEvents}</div>
                    <div class="stat-change">üéØ Identificados</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-header">Sinais de Alta Signific√¢ncia</div>
                    <div class="stat-value">${highSignificance}</div>
                    <div class="stat-change">‚ö†Ô∏è PRR ‚â• 2, Count ‚â• 3</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-header">PRR M√©dio</div>
                    <div class="stat-value">${avgPRR}</div>
                    <div class="stat-change">üìà Raz√£o de Notifica√ß√£o</div>
                </div>
            `;

            document.getElementById('statsOverview').innerHTML = statsHtml;
        }

        function displayAdvancedChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            const chartType = document.getElementById('chartType').value;
            const limit = parseInt(document.getElementById('chartLimit').value);
            const topEvents = allEventData.slice(0, limit);

            const chartData = {
                labels: topEvents.map(event => 
                    event.term.length > 25 ? event.term.substring(0, 25) + '...' : event.term
                ),
                datasets: [{
                    label: 'N√∫mero de Relat√≥rios',
                    data: topEvents.map(event => event.count),
                    backgroundColor: generateColors(topEvents.length),
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2
                }]
            };

            currentChart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie' || chartType === 'doughnut'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const event = topEvents[context.dataIndex];
                                    return [
                                        `PRR: ${event.prr}`,
                                        `ROR: ${event.ror}`,
                                        `IC: ${event.ic}`,
                                        `Medicamento: ${event.drug}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: { grid: { display: false } }
                    } : {}
                }
            });
        }

        function displayTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) {
                timelineChart.destroy();
            }

            if (!timelineData || timelineData.length === 0) return;

            // Process and sort timeline data
            const allDates = new Set();
            timelineData.forEach(drugData => {
                drugData.timeline.forEach(item => {
                    allDates.add(item.time);
                });
            });

            const sortedDates = Array.from(allDates).sort();
            const formattedLabels = sortedDates.map(date => {
                // Convert YYYYMMDD to MM/YYYY format
                const year = date.substring(0, 4);
                const month = date.substring(4, 6);
                return `${month}/${year}`;
            });

            const datasets = timelineData.map((drugData, index) => {
                const color = generateColors(timelineData.length)[index];
                
                // Create data array matching sorted dates
                const data = sortedDates.map(date => {
                    const found = drugData.timeline.find(item => item.time === date);
                    return found ? found.count : 0;
                });

                return {
                    label: drugData.drug,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    tension: 0.1
                };
            });

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: formattedLabels,
                    datasets: datasets 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Per√≠odo (M√™s/Ano)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Relat√≥rios'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tend√™ncia Temporal de Relat√≥rios'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function displayTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }

            if (!timelineData || timelineData.length === 0) return;

            // Aggregate data by month
            const monthlyData = {};
            timelineData.forEach(drugData => {
                drugData.timeline.forEach(item => {
                    const month = item.time.substring(0, 6); // YYYYMM
                    if (!monthlyData[month]) monthlyData[month] = {};
                    if (!monthlyData[month][drugData.drug]) monthlyData[month][drugData.drug] = 0;
                    monthlyData[month][drugData.drug] += item.count;
                });
            });

            const months = Object.keys(monthlyData).sort();
            const drugs = [...new Set(timelineData.map(d => d.drug))];

            const datasets = drugs.map((drug, index) => {
                const color = generateColors(drugs.length)[index];
                return {
                    label: drug,
                    data: months.map(month => monthlyData[month][drug] || 0),
                    borderColor: color,
                    backgroundColor: color + '40',
                    fill: false
                };
            });

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => `${m.substring(4)}/20${m.substring(2,4)}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Relat√≥rios por M√™s'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tend√™ncias Mensais'
                        }
                    }
                }
            });

            // Generate heatmap
            generateHeatmap();
        }

        function generateHeatmap() {
            const container = document.getElementById('heatmapViz');
            container.innerHTML = '';

            if (!timelineData || timelineData.length === 0) return;

            // Create a simple heatmap representation
            const monthlyTotals = {};
            timelineData.forEach(drugData => {
                drugData.timeline.forEach(item => {
                    const month = item.time.substring(0, 6);
                    if (!monthlyTotals[month]) monthlyTotals[month] = 0;
                    monthlyTotals[month] += item.count;
                });
            });

            const months = Object.keys(monthlyTotals).sort();
            const maxValue = Math.max(...Object.values(monthlyTotals));

            months.forEach(month => {
                const intensity = monthlyTotals[month] / maxValue;
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.style.backgroundColor = `rgba(102, 126, 234, ${intensity})`;
                cell.title = `${month}: ${monthlyTotals[month]} relat√≥rios`;
                container.appendChild(cell);
            });

            // Add legend
            const legend = document.createElement('div');
            legend.className = 'heatmap-legend';
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(102, 126, 234, 0.2)"></div>
                    <span>Baixo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(102, 126, 234, 0.6)"></div>
                    <span>M√©dio</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(102, 126, 234, 1)"></div>
                    <span>Alto</span>
                </div>
            `;
            container.appendChild(legend);
        }

        function displayAdvancedTable() {
            const tableBody = document.getElementById('tableBody');
            
            const rows = allEventData.slice(0, 100).map(event => {
                const badgeClass = event.significance === 'high' ? 'prr-high' : 
                                 event.significance === 'medium' ? 'prr-medium' : 'prr-low';
                const statusText = event.significance === 'high' ? 'Alto Risco' :
                                 event.significance === 'medium' ? 'Risco M√©dio' : 'Baixo Risco';

                return `
                    <tr>
                        <td>${event.term}</td>
                        <td>${event.count.toLocaleString()}</td>
                        <td>${event.percentage}%</td>
                        <td>${event.prr}</td>
                        <td>${event.ror}</td>
                        <td>${event.ic}</td>
                        <td><span class="prr-badge ${badgeClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;" 
                                    onclick="showEventDetails('${event.term.replace(/'/g, "\\'")}', '${event.drug}', ${event.count}, '${event.prr}', '${event.ror}', '${event.ic}', '${event.significance}')">
                                Ver Detalhes
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function updateDrugSelectors() {
            if (!currentData) return;

            const drugASelect = document.getElementById('drugA');
            const drugBSelect = document.getElementById('drugB');

            drugASelect.innerHTML = '<option value="">Selecione...</option>';
            drugBSelect.innerHTML = '<option value="">Selecione...</option>';

            currentData.drugs.forEach(drug => {
                drugASelect.innerHTML += `<option value="${drug}">${drug}</option>`;
                drugBSelect.innerHTML += `<option value="${drug}">${drug}</option>`;
            });
        }

        function generateComparison() {
            const drugA = document.getElementById('drugA').value;
            const drugB = document.getElementById('drugB').value;

            if (!drugA || !drugB) {
                alert('Selecione dois medicamentos para comparar.');
                return;
            }

            if (drugA === drugB) {
                alert('Selecione medicamentos diferentes para comparar.');
                return;
            }

            const eventsA = allEventData.filter(e => e.drug === drugA).slice(0, 10);
            const eventsB = allEventData.filter(e => e.drug === drugB).slice(0, 10);

            displayComparisonChart(eventsA, eventsB, drugA, drugB);
            displayComparisonMetrics(eventsA, eventsB, drugA, drugB);

            document.getElementById('comparisonView').style.display = 'grid';
        }

        function displayComparisonChart(eventsA, eventsB, drugA, drugB) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const events = [...new Set([...eventsA.map(e => e.term), ...eventsB.map(e => e.term)])];
            
            const dataA = events.map(event => {
                const found = eventsA.find(e => e.term === event);
                return found ? found.count : 0;
            });

            const dataB = events.map(event => {
                const found = eventsB.find(e => e.term === event);
                return found ? found.count : 0;
            });

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: events.map(e => e.length > 20 ? e.substring(0, 20) + '...' : e),
                    datasets: [
                        {
                            label: drugA,
                            data: dataA,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: drugB,
                            data: dataB,
                            backgroundColor: 'rgba(72, 187, 120, 0.8)',
                            borderColor: 'rgba(72, 187, 120, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Relat√≥rios'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Compara√ß√£o: ${drugA} vs ${drugB}`
                        }
                    }
                }
            });
        }

        function displayComparisonMetrics(eventsA, eventsB, drugA, drugB) {
            const totalA = eventsA.reduce((sum, e) => sum + e.count, 0);
            const totalB = eventsB.reduce((sum, e) => sum + e.count, 0);
            const avgPRR_A = eventsA.length > 0 ? (eventsA.reduce((sum, e) => sum + parseFloat(e.prr), 0) / eventsA.length).toFixed(2) : 0;
            const avgPRR_B = eventsB.length > 0 ? (eventsB.reduce((sum, e) => sum + parseFloat(e.prr), 0) / eventsB.length).toFixed(2) : 0;

            const metricsHtml = `
                <div class="advanced-metrics">
                    <div class="metric-item">
                        <div class="metric-value">${totalA.toLocaleString()}</div>
                        <div class="metric-label">${drugA} - Total Eventos</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${totalB.toLocaleString()}</div>
                        <div class="metric-label">${drugB} - Total Eventos</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${avgPRR_A}</div>
                        <div class="metric-label">${drugA} - PRR M√©dio</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${avgPRR_B}</div>
                        <div class="metric-label">${drugB} - PRR M√©dio</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${eventsA.length}</div>
                        <div class="metric-label">${drugA} - Tipos de Eventos</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${eventsB.length}</div>
                        <div class="metric-label">${drugB} - Tipos de Eventos</div>
                    </div>
                </div>
            `;

            document.getElementById('comparisonMetrics').innerHTML = metricsHtml;
        }

        function showEventDetails(eventTerm, drugName, count, prr, ror, ic, significance) {
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `Detalhes: ${eventTerm}`;

            const statusText = significance === 'high' ? 'Alto Risco' :
                             significance === 'medium' ? 'Risco M√©dio' : 'Baixo Risco';
            const badgeClass = significance === 'high' ? 'prr-high' : 
                             significance === 'medium' ? 'prr-medium' : 'prr-low';

            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Medicamento</div>
                        <div class="detail-value">${drugName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">N√∫mero de Relat√≥rios</div>
                        <div class="detail-value">${parseInt(count).toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">PRR (Proportional Reporting Ratio)</div>
                        <div class="detail-value">${prr}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ROR (Reporting Odds Ratio)</div>
                        <div class="detail-value">${ror}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">IC (Information Component)</div>
                        <div class="detail-value">${ic}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Classifica√ß√£o de Risco</div>
                        <div class="detail-value">
                            <span class="prr-badge ${badgeClass}">${statusText}</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4>Interpreta√ß√£o das M√©tricas</h4>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 15px;">
                        <p><strong>PRR (Proportional Reporting Ratio):</strong> Valores ‚â• 2 com pelo menos 3 casos podem indicar um sinal de seguran√ßa.</p>
                        <p><strong>ROR (Reporting Odds Ratio):</strong> Similar ao PRR, valores elevados podem indicar uma associa√ß√£o potencial.</p>
                        <p><strong>IC (Information Component):</strong> Valores positivos podem sugerir um sinal de despropor√ß√£o.</p>
                        <p style="margin-top: 15px;"><em>Nota: Estes s√£o sinais estat√≠sticos que requerem investiga√ß√£o adicional. N√£o implicam causalidade.</em></p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>Contexto Cl√≠nico</h4>
                    <div style="background: #e6fffa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                        <p>O evento adverso "<strong>${eventTerm}</strong>" foi reportado <strong>${parseInt(count).toLocaleString()}</strong> vez(es) para o medicamento <strong>${drugName}</strong>.</p>
                        <p style="margin-top: 10px;">Esta an√°lise √© baseada em dados de farmacovigil√¢ncia p√≥s-comercializa√ß√£o e deve ser interpretada por profissionais de sa√∫de qualificados.</p>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function updateChart() {
            if (allEventData.length > 0) {
                displayAdvancedChart();
            }
        }

        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 360 / count) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            return colors;
        }

        function filterTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const eventName = row.cells[0].textContent.toLowerCase();
                row.style.display = eventName.includes(searchTerm) ? '' : 'none';
            });
        }

        function sortTable() {
            const sortBy = document.getElementById('sortBy').value;
            let sortedData = [...allEventData];

            switch (sortBy) {
                case 'count':
                    sortedData.sort((a, b) => b.count - a.count);
                    break;
                case 'prr':
                    sortedData.sort((a, b) => b.prr - a.prr);
                    break;
                case 'ror':
                    sortedData.sort((a, b) => b.ror - a.ror);
                    break;
                case 'event':
                    sortedData.sort((a, b) => a.term.localeCompare(b.term));
                    break;
            }

            allEventData = sortedData;
            displayAdvancedTable();
        }

        // Export functions
        function exportToCSV() {
            if (!allEventData.length) {
                alert('Nenhum dado para exportar. Execute uma busca primeiro.');
                return;
            }

            const includeCI = document.getElementById('includeCI').value === 'true';

            let csv = 'Evento Adverso,Medicamento,Contagem,Percentual,PRR,ROR,IC,Signific√¢ncia';
            if (includeCI) csv += ',PRR_CI_Lower,PRR_CI_Upper';
            csv += '\n';

            csv += allEventData.map(event => {
                let row = `"${event.term}","${event.drug}",${event.count},${event.percentage}%,${event.prr},${event.ror},${event.ic},"${event.significance}"`;
                if (includeCI) {
                    const ci_lower = (parseFloat(event.prr) * 0.8).toFixed(2);
                    const ci_upper = (parseFloat(event.prr) * 1.2).toFixed(2);
                    row += `,${ci_lower},${ci_upper}`;
                }
                return row;
            }).join('\n');

            downloadFile(csv, `faers_advanced_analysis_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportToJSON() {
            if (!currentData) {
                alert('Nenhum dado para exportar. Execute uma busca primeiro.');
                return;
            }

            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    searchParameters: currentData.searchParams,
                    drugsAnalyzed: currentData.drugs,
                    totalEvents: allEventData.length,
                    analysisType: 'Advanced FAERS Analysis'
                },
                statistics: {
                    totalReports: allEventData.reduce((sum, e) => sum + e.count, 0),
                    uniqueEvents: new Set(allEventData.map(e => e.term)).size,
                    highSignificanceEvents: allEventData.filter(e => e.significance === 'high').length
                },
                events: allEventData.map(event => ({
                    event: event.term,
                    drug: event.drug,
                    count: event.count,
                    percentage: parseFloat(event.percentage),
                    prr: parseFloat(event.prr),
                    ror: parseFloat(event.ror),
                    ic: parseFloat(event.ic),
                    significance: event.significance
                }))
            };

            downloadFile(JSON.stringify(exportData, null, 2), 
                        `faers_analysis_${new Date().toISOString().split('T')[0]}.json`, 
                        'application/json');
        }

        function exportToPDF() {
            alert('Funcionalidade de PDF ser√° implementada em vers√£o futura.');
        }

        function exportCharts() {
            if (currentChart) {
                const url = currentChart.toBase64Image();
                const link = document.createElement('a');
                link.download = `faers_chart_${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
            } else {
                alert('Nenhum gr√°fico dispon√≠vel para exportar.');
            }
        }

        function exportStatistics() {
            alert('Exporta√ß√£o de planilha estat√≠stica ser√° implementada em vers√£o futura.');
        }

        function exportForR() {
            if (!allEventData.length) {
                alert('Nenhum dado para exportar. Execute uma busca primeiro.');
                return;
            }

            let rScript = `# FAERS Analysis Dataset - Generated on ${new Date().toISOString()}\n`;
            rScript += `# Load required libraries\nlibrary(dplyr)\nlibrary(ggplot2)\n\n`;
            rScript += `# Create dataset\nfaers_data <- data.frame(\n`;
            rScript += `  event = c(${allEventData.map(e => `"${e.term.replace(/"/g, '\\"')}"`).join(', ')}),\n`;
            rScript += `  drug = c(${allEventData.map(e => `"${e.drug}"`).join(', ')}),\n`;
            rScript += `  count = c(${allEventData.map(e => e.count).join(', ')}),\n`;
            rScript += `  prr = c(${allEventData.map(e => e.prr).join(', ')}),\n`;
            rScript += `  ror = c(${allEventData.map(e => e.ror).join(', ')}),\n`;
            rScript += `  ic = c(${allEventData.map(e => e.ic).join(', ')}),\n`;
            rScript += `  significance = c(${allEventData.map(e => `"${e.significance}"`).join(', ')})\n`;
            rScript += `)\n\n`;
            rScript += `# Basic analysis examples\n`;
            rScript += `summary(faers_data)\n`;
            rScript += `table(faers_data$significance)\n`;
            rScript += `hist(faers_data$prr, main="PRR Distribution")\n`;

            downloadFile(rScript, `faers_analysis_${new Date().toISOString().split('T')[0]}.R`, 'text/plain');
        }

        // Save/Load searches
        function saveSearch() {
            const searchName = prompt('Nome para esta busca:');
            if (!searchName) return;

            const searchData = {
                name: searchName,
                timestamp: new Date().toISOString(),
                params: {
                    drugNames: document.getElementById('drugNames').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    ageRange: document.getElementById('ageRange').value,
                    gender: document.getElementById('gender').value,
                    country: document.getElementById('country').value,
                    serious: document.getElementById('serious').value,
                    reporterType: document.getElementById('reporterType').value,
                    outcomes: getSelectedOutcomes()
                }
            };

            savedSearches.push(searchData);
            try {
                localStorage.setItem('faers_searches', JSON.stringify(savedSearches));
                updateSavedSearchesList();
                alert('Busca salva com sucesso!');
            } catch (e) {
                console.error('Error saving search:', e);
                alert('Erro ao salvar busca.');
            }
        }

        function loadSavedSearch() {
            if (savedSearches.length === 0) {
                alert('Nenhuma busca salva encontrada.');
                return;
            }

            document.getElementById('savedSearches').style.display = 'block';
            updateSavedSearchesList();
        }

        function updateSavedSearchesList() {
            const list = document.getElementById('savedSearchList');
            list.innerHTML = savedSearches.map((search, index) => `
                <div class="saved-search-item">
                    <div>
                        <strong>${search.name}</strong><br>
                        <small>${new Date(search.timestamp).toLocaleString()}</small>
                    </div>
                    <div>
                        <button class="btn btn-outline" style="padding: 5px 10px; margin-right: 5px;" 
                                onclick="applySavedSearch(${index})">Carregar</button>
                        <button class="btn btn-outline" style="padding: 5px 10px;" 
                                onclick="deleteSavedSearch(${index})">‚ùå</button>
                    </div>
                </div>
            `).join('');
        }

        function applySavedSearch(index) {
            const search = savedSearches[index];
            const params = search.params;

            document.getElementById('drugNames').value = params.drugNames;
            document.getElementById('startDate').value = params.startDate;
            document.getElementById('endDate').value = params.endDate;
            document.getElementById('ageRange').value = params.ageRange;
            document.getElementById('gender').value = params.gender;
            document.getElementById('country').value = params.country;
            document.getElementById('serious').value = params.serious;
            document.getElementById('reporterType').value = params.reporterType;

            // Set outcomes
            document.getElementById('death').checked = params.outcomes.includes('DE');
            document.getElementById('hospitalization').checked = params.outcomes.includes('HO');
            document.getElementById('disability').checked = params.outcomes.includes('DS');
            document.getElementById('lifeThreat').checked = params.outcomes.includes('LT');

            document.getElementById('savedSearches').style.display = 'none';
            alert('Busca carregada com sucesso!');
        }

        function deleteSavedSearch(index) {
            if (confirm('Tem certeza que deseja excluir esta busca?')) {
                savedSearches.splice(index, 1);
                try {
                    localStorage.setItem('faers_searches', JSON.stringify(savedSearches));
                    updateSavedSearchesList();
                } catch (e) {
                    console.error('Error deleting search:', e);
                    alert('Erro ao excluir busca.');
                }
            }
        }

        function resetForm() {
            if (confirm('Tem certeza que deseja limpar todos os campos?')) {
                document.getElementById('advancedSearchForm').reset();
                document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('startDate').value = '2022-01-01';
            }
        }

        // Utility functions
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('searchBtn').disabled = show;
        }

        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('loadingStatus').textContent = status;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('FAERS Advanced Research Platform initialized');
        });
    </script>
</body>
</html>
